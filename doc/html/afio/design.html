<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Design Introduction and Rationale</title>
<link rel="stylesheet" href="../../../libs/afio/doc/html/myboostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.76.1">
<link rel="home" href="../afio.html" title="Chapter&#160;1.&#160;Boost.AFIO 1.30">
<link rel="up" href="../afio.html" title="Chapter&#160;1.&#160;Boost.AFIO 1.30">
<link rel="prev" href="introduction.html" title="Introduction">
<link rel="next" href="design/overview.html" title="A quick overview of the design">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../boost.png"></td>
<td align="center"><a href="../../../index.html">Home</a></td>
<td align="center"><a href="../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="introduction.html"><img src="../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../afio.html"><img src="../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../afio.html"><img src="../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="design/overview.html"><img src="../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="afio.design"></a><a class="link" href="design.html" title="Design Introduction and Rationale">Design Introduction and Rationale</a>
</h2></div></div></div>
<div class="toc"><dl>
<dt><span class="section"><a href="design/overview.html">A quick overview of the design</a></span></dt>
<dt><span class="section"><a href="design/acid_write_ordering.html">Write ordering constraints,
      and how these can be used to achieve some of the Durability in ACID without
      needing <code class="computeroutput"><span class="identifier">fsync</span><span class="special">()</span></code></a></span></dt>
<dd><dl>
<dt><span class="section"><a href="design/acid_write_ordering/background.html">Background
        on how filing systems work</a></span></dt>
<dt><span class="section"><a href="design/acid_write_ordering/write_ordering_data.html">Write
        ordering data and durability: why does it matter?</a></span></dt>
</dl></dd>
</dl></div>
<p>
      Boost.AFIO came about out of the need for a scalable, high performance, portable
      asynchronous file i/o implementation library for a forthcoming filing system
      based graph store ACID compliant transactional persistence layer called TripleGit
      &#8212; call it a <span class="quote">&#8220;<span class="quote">SQLite3 but for graphstores</span>&#8221;</span><sup>[<a name="afio.design.f0" href="#ftn.afio.design.f0" class="footnote">1</a>]</sup>. The fact that a portable asynchronous file i/o library for C++
      was needed at all came as a bit of a surprise: one thinks of these things as
      done and dusted decades ago, but it turns out that the fully featured <a href="http://nikhilm.github.io/uvbook/filesystem.html" target="_top">libuv</a>, a C library,
      is good enough for most people needing portable asynchronous file i/o. However
      as great as libuv is, it isn't very C++-ish, and hooking it in with <a href="http://www.boost.org/libs/asio/" target="_top">Boost.ASIO</a> (parts of which are
      expected to enter the ISO C++ language standard) isn't particularly clean.
      I therefore resolved to write a native Boost asynchronous file i/o implementation,
      and keep it as simple as possible.
    </p>
<p>
      For v1.0, AFIO used a simple dispatch engine which kept the extant ops in a
      hash table, and the entire dispatch engine was protected by a single giant
      and recursive mutex. Performance never exceeded about 150k ops/sec maximum
      on a four core Intel Ivy Bridge CPU.
    </p>
<p>
      That performance was embarrassing, so for v1.1 the entire engine was rewritten
      using vast numbers of atomics to be completely lock free, and very nearly wait
      free if it weren't for the thin spin locks around the central ops hash table.
      Now performance can reach 1.5m ops/sec on a four core Intel Ivy Bridge CPU,
      or more than half of Boost.ASIO's maximum dispatch rate.
    </p>
<p>
      For the v1.2 engine, another large refactor was done, this time to substantially
      simplify the engine by removing the use of <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">packaged_task</span><span class="special">&lt;&gt;</span></code> completely, replacing it with a new
      intrusive-capable <code class="computeroutput"><span class="identifier">enqueued_task</span><span class="special">&lt;&gt;</span></code> which permits the engine to early out
      in many cases, plus allowing the consolidation of all spinlocked points down
      to just two: one in dispatch, and one other in completion, which is now optimal.
      Performance of the v1.2 engine rose by about 20% over the v1.1 engine, plus
      AFIO is now fully clean on all race detecting tools.
    </p>
<p>
      For the v1.3 engine, yet another large refactor was done, though not for performance
      but rather to make it much easier to maintain AFIO in the future, especially
      after acceptance into Boost whereupon one cannot arbitrarily break API anymore,
      and one must maintain backwards compatibility. To this end the dependencies
      between AFIO and Boost were completely abstracted into a substitutable symbol
      aliasing layer such that any combination of Boost and C++ 11 STL threading/chrono,
      filesystem and networking can be selected externally using macros. Indeed,
      any of the eight build combinations can coexist in the same translation unit
      too, I have unit test runs which prove it! With the v1.3 engine AFIO optionally
      no longer needs Boost at all, not even for its unit testing. However the cost
      was dropping support for all Visual Studios before 2013 and all GCCs before
      4.7 as they don't have the template aliasing support needed to implement the
      STL abstraction layer.
    </p>
<p>
      We're not done yet however! The v1.4 engine will involve another large refactor,
      this time to make the AFIO API much easier to use as we'll be introducing a
      custom future type to replace async_io_op, and that lets us hook much more
      friendly programming onto it. We'll also be eliminating even more code from
      the dispatch loop, and hopefully will reign in the huge stochastic variance
      in dispatch latency in the v1.3 and earlier engines.
    </p>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a id="ftn.afio.design.f0" href="#afio.design.f0" class="para">1</a>] </sup>
        The <a href="http://unqlite.org/" target="_top">UnQLite embedded NoSQL database engine</a>
        is exactly one of those of course. Unfortunately I intend TripleGit for implementing
        portable Component Objects for C++ extending C++ Modules, which means I need
        a database engine suitable for incorporation into a dynamic linker, which
        unfortunately is not quite UnQLite.
      </p></div>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2013-2015 Niall Douglas
      and Paul Kirth<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="introduction.html"><img src="../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../afio.html"><img src="../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../afio.html"><img src="../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="design/overview.html"><img src="../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
